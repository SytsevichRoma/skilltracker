{% extends "base.html" %}
{% block title %}7 days{% endblock %}

{% block content %}
  <h2>–ü–ª–∞–Ω –Ω–∞ 7 –¥–Ω—ñ–≤</h2>

  <p>
    <a href="{{ url_for('goals.list_goals') }}">Goals</a> |
    <a href="{{ url_for('auth.logout') }}">Logout</a>
  </p>

  {% if not goals %}
    <p><b>–°–ø–æ—á–∞—Ç–∫—É —Å—Ç–≤–æ—Ä–∏ —Ö–æ—á–∞ –± –æ–¥–Ω—É Goal</b>, –±–æ –∑–∞–¥–∞—á–∞ –º–∞—î –Ω–∞–ª–µ–∂–∞—Ç–∏ –¥–æ Goal.</p>
    <p><a href="{{ url_for('goals.create_goal') }}">+ Create goal</a></p>
    <hr>
  {% endif %}

  {% for d in days %}
    {% set day = tasks_by_day[d] %}
    <details {% if loop.first %}open{% endif %}>
      <summary style="cursor:pointer;">
        <b>{{ d.strftime("%a, %d %b %Y") }}</b>
        ‚Äî {{ day.done }}/{{ day.total }} ({{ day.percent }}%)
      </summary>

      <div style="padding: 10px 0;">
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <form method="post" action="{{ url_for('tasks.copy_day_to_tomorrow', day_str=d.isoformat()) }}">
            <button type="submit">Copy to tomorrow</button>
          </form>

          <form method="post" action="{{ url_for('tasks.mark_all_done', day_str=d.isoformat()) }}"
                onsubmit="return confirm('–ü–æ–∑–Ω–∞—á–∏—Ç–∏ –≤—Å—ñ –∑–∞–¥–∞—á—ñ –¥–Ω—è —è–∫ Done?');">
            <button type="submit">Mark all done</button>
          </form>

          <form method="post" action="{{ url_for('tasks.clear_day', day_str=d.isoformat()) }}"
                onsubmit="return confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ –∑–∞–¥–∞—á—ñ —Ü—å–æ–≥–æ –¥–Ω—è?');">
            <button type="submit">Clear day üóëÔ∏è</button>
          </form>
        </div>

        <hr>

        <h4>Add task</h4>
        <form method="post" action="{{ url_for('tasks.create_task') }}">
          <input type="hidden" name="planned_for" value="{{ d.isoformat() }}">

          <input type="text" name="title" placeholder="Task title..." required>

          <select name="task_type">
            {% for key, label in task_types %}
              <option value="{{ key }}">{{ label }}</option>
            {% endfor %}
          </select>

          <select name="goal_id" {% if not goals %}disabled{% endif %} required>
            {% for g in goals %}
              <option value="{{ g.id }}">{{ g.title }}</option>
            {% endfor %}
          </select>

          <label>
            –î–µ–¥–ª–∞–π–Ω –¥–æ:
            <input type="date" name="due_date">
          </label>

          <button type="submit" {% if not goals %}disabled{% endif %}>Add</button>
        </form>

        <hr>

        {% for code in ["DREAM","GOAL","MUST"] %}
          <h4>{{ "–ú—Ä—ñ—ó" if code=="DREAM" else ("–ú–µ—Ç–∏" if code=="GOAL" else "–û–±–æ–≤'—è–∑–∫–æ–≤—ñ") }}</h4>

          {% set items = day.groups[code] %}
          {% if items %}
            <ul>
              {% for t in items %}
                <li>
                  {% if t.is_done %}‚úÖ{% else %}‚è≥{% endif %}
                  <b>{{ t.title }}</b>

                  {% if t.due_date %}
                    <span style="margin-left:10px;">(–¥–æ {{ t.due_date.isoformat() }})</span>
                  {% endif %}

                  <!-- move (7 days select) -->
                  <form method="post" action="{{ url_for('tasks.move_task', task_id=t.id) }}" style="display:inline;">
                    <select name="planned_for">
                      {% for dd in days %}
                        <option value="{{ dd.isoformat() }}" {% if dd==d %}selected{% endif %}>
                          {{ dd.strftime("%a %d") }}
                        </option>
                      {% endfor %}
                    </select>
                    <button type="submit">Move</button>
                  </form>

                  <form method="post" action="{{ url_for('tasks.toggle_task', task_id=t.id) }}" style="display:inline;">
                    <button type="submit">Toggle</button>
                  </form>

                  <a href="{{ url_for('tasks.edit_task', task_id=t.id) }}">Edit</a>

                  <form method="post" action="{{ url_for('tasks.delete_task', task_id=t.id) }}"
                        style="display:inline;" onsubmit="return confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –∑–∞–¥–∞—á—É?');">
                    <button type="submit">Delete</button>
                  </form>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p style="opacity:0.8;">–ù–µ–º–∞ –∑–∞–¥–∞—á —Ü—å–æ–≥–æ —Ç–∏–ø—É</p>
          {% endif %}

          <br>
        {% endfor %}
      </div>
    </details>

    <br>
  {% endfor %}
{% endblock %}
